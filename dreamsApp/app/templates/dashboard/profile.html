{% extends 'base.html' %}
{% block content %}

<style>
    body {
        background-color: #121212;
        color: #e0e0e0;
    }

    h2.section-title {
        font-weight: 600;
        margin-bottom: 1rem;
        color: #ffffff;
    }

    p.section-description {
        font-size: 1rem;
        color: #cccccc;
        margin-bottom: 2rem;
    }

    .section {
        padding: 3rem 0;
        border-top: 1px solid #333;
    }

    .card {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 1rem;
        transition: transform 0.2s;
        color: #e0e0e0;
    }

    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 0.5rem 1rem rgba(255, 255, 255, 0.05);
    }

    .card-header {
        font-weight: 500;
        font-size: 1.1rem;
        border-bottom: none;
        background-color: transparent;
        color: #ffffff;
    }

    .img-section img {
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(255, 255, 255, 0.05);
        max-height: 500px;
        object-fit: contain;
    }

    .btn-outline-primary {
        border-color: #90caf9;
        color: #90caf9;
    }

    .btn-outline-primary:hover {
        background-color: #90caf9;
        color: #121212;
    }

    .border-success-subtle {
        border-color: #2e7d32 !important;
    }

    .border-danger-subtle {
        border-color: #c62828 !important;
    }

    .bg-success {
        background-color: #2e7d32 !important;
    }

    .bg-danger {
        background-color: #c62828 !important;
    }
</style>

<div class="container">

    <!-- Sentiment Trend -->
    <section class="section text-center">
        <h2 class="section-title">How Has the Mood Changed Over Time?</h2>
        <p class="section-description">
            This chart shows how the user's emotional tone has shifted over time, based on their shared captions.
        </p>
        <div class="img-section">
            <img src="data:image/png;base64,{{ plot_url }}" alt="Sentiment Trend Over Time" class="img-fluid">
        </div>
    </section>

    <!-- CHIME Recovery Framework -->
    <section class="section text-center">
        <h2 class="section-title">Recovery Dimensions (CHIME)</h2>
        <p class="section-description">
            This chart visualizes alignment with the five key processes of personal recovery: Connectedness, Hope, Identity, Meaning, and Empowerment.
        </p>
        <div class="img-section">
            <img src="data:image/png;base64,{{ chime_plot_url }}" alt="CHIME Radar Chart" class="img-fluid" style="max-height: 500px;">
        </div>
        <div class="row mt-4 justify-content-center">
            <div class="col-auto px-3"><small style="color: #90caf9;"><strong>C</strong>onnectedness</small></div>
            <div class="col-auto px-3"><small style="color: #90caf9;"><strong>H</strong>ope</small></div>
            <div class="col-auto px-3"><small style="color: #90caf9;"><strong>I</strong>dentity</small></div>
            <div class="col-auto px-3"><small style="color: #90caf9;"><strong>M</strong>eaning</small></div>
            <div class="col-auto px-3"><small style="color: #90caf9;"><strong>E</strong>mpowerment</small></div>
        </div>
    </section>

    <!-- Wordclouds -->
    <section class="section">
        <div class="row justify-content-center text-center">
            <div class="col-md-6 mb-4" style="border-right: 3px solid #333;">
                <h2 class="section-title">What Makes Them Smile?</h2>
                <p class="section-description">These are the most common words in positive moments.</p>
                <img src="data:image/png;base64,{{ positive_wordcloud_url }}" alt="Positive Word Cloud" class="img-fluid">
            </div>
            <div class="col-md-6 mb-4">
                <h2 class="section-title">Whatâ€™s Been Difficult?</h2>
                <p class="section-description">These are the words often found in negative or hard moments.</p>
                <img src="data:image/png;base64,{{ negative_wordcloud_url }}" alt="Negative Word Cloud" class="img-fluid">
            </div>
        </div>
    </section>

    <!-- Positive Themes -->
    <section class="section text-center">
        <h2 class="section-title">Uplifting Themes</h2>
        <p class="section-description">
            These recurring ideas and topics show what brings hope, joy, or comfort to the user.
        </p>
        <div class="row justify-content-center">
            {% for item in thematics.positive %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 border border-success-subtle shadow-sm">
                    <div class="card-header bg-success bg-opacity-75 text-white">
                        {{ item.theme }}
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ item.meaning }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Negative Themes -->
    <section class="section text-center">
        <h2 class="section-title">Challenging Themes</h2>
        <p class="section-description">
            These themes reflect pain points or struggles that appear frequently in the userâ€™s expressions.
        </p>
        <div class="row justify-content-center">
            {% for item in thematics.negative %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 border border-danger-subtle shadow-sm">
                    <div class="card-header bg-danger bg-opacity-75 text-white">
                        {{ item.theme }}
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ item.meaning }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="text-end my-3">
                <button class="btn btn-outline-primary" onclick="refreshThematic()">ðŸ”„ Refresh Thematic Analysis</button>
            </div>
        </div>
    </section>

    <!-- Latest Analysis & Feedback -->
    {% if latest_post %}
    <section class="section">
        <h2 class="section-title text-center">Latest Entry Analysis</h2>
        
        <div class="list-group">
            <div class="list-group-item bg-dark text-white border-secondary mb-3 rounded p-4">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1 text-info">{{ latest_post.timestamp.strftime('%Y-%m-%d %H:%M') }}</h5>
                    <small class="text-muted">Sentiment: {{ latest_post.sentiment.label }}</small>
                </div>
                <p class="mb-2 mt-3 fst-italic display-6" style="font-size: 1.25em;">"{{ latest_post.caption }}"</p>
                
                <div class="mt-4 p-3 border rounded border-secondary bg-secondary bg-opacity-10">
                    <div class="d-flex align-items-center mb-3">
                        <span class="text-light me-2">AI Classification:</span>
                        {% set current_label = latest_post.corrected_label if latest_post.corrected_label else latest_post.chime_analysis.label %}
                        <span class="badge bg-info text-dark fs-5">
                            {{ current_label }}
                        </span>
                        {% if latest_post.corrected_label %}
                            <span class="badge bg-success text-white ms-2">Verified âœ“</span>
                        {% endif %}
                    </div>

                    {% if not latest_post.corrected_label %}
                    <div class="d-flex gap-2" id="action-buttons-{{ latest_post._id }}">
                        <button class="btn btn-success" onclick="acceptPrediction('{{ latest_post._id }}', '{{ latest_post.chime_analysis.label }}')">
                            Accept Prediction
                        </button>
                        <button class="btn btn-outline-light" onclick="toggleEdit('{{ latest_post._id }}')">
                            Edit Prediction
                        </button>
                    </div>

                    <!-- Hidden Edit Form -->
                    <div id="edit-form-{{ latest_post._id }}" class="mt-3 p-3 border border-info rounded" style="display: none;">
                        <label class="form-label text-info small">Select the correct recovery dimension:</label>
                        <div class="input-group">
                            <select class="form-select bg-dark text-white border-secondary" id="select-{{ latest_post._id }}">
                                <option value="Connectedness">Connectedness - Support, relationships, community</option>
                                <option value="Hope">Hope - Optimism, belief in recovery</option>
                                <option value="Identity">Identity - Rebuilding self, overcoming stigma</option>
                                <option value="Meaning">Meaning - Purpose, goals, spirituality</option>
                                <option value="Empowerment">Empowerment - Control, responsibility, strengths</option>
                                <option value="None">None - Does not fit CHIME dimensions</option>
                            </select>
                            <button class="btn btn-info" onclick="submitCorrection('{{ latest_post._id }}')">Save Correction</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
    {% endif %}

</div>

<script>
    const userId = "{{ user_id }}";

    function toggleEdit(postId) {
        const axButtons = document.getElementById(`action-buttons-${postId}`);
        if(axButtons) axButtons.style.display = 'none';
        
        const form = document.getElementById(`edit-form-${postId}`);
        form.style.display = 'block';
    }

    function acceptPrediction(postId, label) {
        submitCorrectionData(postId, label);
    }

    function submitCorrection(postId) {
        const select = document.getElementById(`select-${postId}`);
        const newValue = select.value; // Value is now cleanly defined in HTML options
        submitCorrectionData(postId, newValue);
    }

    function submitCorrectionData(postId, label) {
        fetch('/dashboard/correct_chime', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_id: postId,
                user_id: userId,
                corrected_label: label
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Determine if it was an accept or an edit for the alert
                // But generally just thanking is fine
                alert('Input recorded! The model will learn from this.');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    function refreshThematic() {
        fetch(`/dashboard/refresh_thematic/${userId}`, {
            method: "POST"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Refreshed successfully!");
                location.reload();
            } else {
                alert("Failed to refresh: " + data.message);
            }
        })
        .catch(error => {
            alert("Failed to refresh: " + error.message);
        });
    }
</script>

{% endblock %}
